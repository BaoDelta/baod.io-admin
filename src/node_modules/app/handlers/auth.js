import {createHash} from "crypto"

export function login(request, reply) {
  const {options} = this
  if (request.auth.isAuthenticated) {
    reply.redirect(request.query.next || "/")
    return
  }
  let message = null
  if (request.method === "post") {
    const hash = createHash("md5").update(request.payload.password).digest("hex")
    const userHash = options.auth[request.payload.username]
    if (hash === userHash) {
      request.auth.session.set({
        id: request.payload.username
      })
      reply.redirect(request.query.next || "/")
      return
    } else {
      message = "Invalid username or password"
    }
  }
  reply(`
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <meta http-equiv="x-ua-compatible" content="ie=edge"/>
        <title>Login</title>
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.2/css/bootstrap.min.css"/>
      </head>
      <body>
        <div class="container">
          ${message ? "<h3>" + message + "</h3>" : ""}
          <form method="POST">
            <fieldset class="form-group">
              <label for="username">Username</label>
              <input type="text" class="form-control" id="username" name="username"/>
            </fieldset>
            <fieldset class="form-group">
              <label for="password">Password</label>
              <input type="password" class="form-control" id="password" name="password"/>
            </fieldset>
            <button type="submit" class="btn btn-primary">Log in</button>
          </form>
        </div>
      </body>
    </html>
  `)
}

export function logout(request, reply) {
  request.auth.session.clear()
  reply.redirect("/")
}
